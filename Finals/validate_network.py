import torch
import numpy as np
import matplotlib.pyplot as plt

from ffnn import FFNN
from eeg_dataset import EEGDataset

from utils import numpy_to_torch, denormalize
from investigate_amplitude import plot_error_amplitude
import test_models as tm
import simple
import amplitude
import area

# palette = sns.color_palette("deep")
# sns.set_palette(palette)

def validate_network(model, parameters):
    name = 'area'
    data = EEGDataset('test', parameters)
    predictions =  data.denormalize(model(data.eeg)).detach().numpy()
    targets = data.denormalize(data.target).detach().numpy()
    # if name == 'amplitude':
    #     plot_error_amplitude(predictions, targets)

    criterea = tm.test_criterea(predictions, targets, name)
    test_results = tm.generate_test_results(predictions, targets)
    tm.print_test_results(test_results)
    tm.save_test_results(test_results, name)



def main():
    # Simple
    # model = torch.load('trained_models/simple_32_0.001_0.35_0.1_0.0_500_(0).pt')
    # model = torch.load('trained_models/simple_32_0.001_0.35_0.5_0.0_500_(0).pt')
    # model = torch.load('trained_models/simple_new_standarization_tanh_32_0.001_0.35_0.1_0_2000_(0).pt')
    # model = torch.load('trained_models/simple_new_standarization_tanh_32_0.001_0.35_0.5_0_500_(5).pt')
    # model = torch.load('trained_models/simple_new_new_standarization_tanh_32_0.001_0.35_0.5_0_500_(0).pt')

    # model = torch.load('trained_models/simple_new_custom_loss_tanh_32_0.001_0.35_0.1_0_2000_(5).pt')
    """
    Mean Euclidean Distance (MED) is 8.27485179901123
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 12 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    5.345     |    19.940    |    69.255     |    84.260     |
    -----------------------------------------------------------------------
    No handles with labels found to put in legend.
    --------------------------------------------------------
    |            |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
    |------------------------------------------------------|
    |     x      |   3.028    |    14.339    |    3.787    |
    |     y      |   3.094    |    14.705    |    3.835    |
    |     z      |   6.143    |    52.319    |    7.233    |
    |  Position  |   4.088    |    27.121    |    5.208    |
    --------------------------------------------------------
    """






    # Amplitude
    # NB, weight = '1, 1'
    # model = torch.load('trained_models/amplitudes_test_custom_loss_tanh_32_0.001_0.35_0.1_0_1500_(0).pt')
    """
    Mean Euclidean Distance (MED) is 2.805983781814575
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    64.325    |    90.930    |    99.505     |    99.925     |
    -----------------------------------------------------------------------
    No handles with labels found to put in legend.
    Mean Absolute Error (MAE) for amplitude is 0.5386642813682556
    ---------------------------------------------------------------------------------
    |             |  MAE < 1.0 mA$mu$m  |  MAE < 2.0 mA$mu$m  |  MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------|
    |  amplitude  |       85.070        |       96.870        |       99.220        |
    ---------------------------------------------------------------------------------
    ---------------------------------------------------------------------------------------------------------------------------------
    |                   |  MED < 10 mm & MAE < 1.0 mA$mu$m  |  MED < 10 mm & MAE < 2.0 mA$mu$m  |  MED < 10 mm & MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------------------------------------------------------|
    |  pos & amplitude  |              84.645               |              96.410               |              98.740               |
    ---------------------------------------------------------------------------------------------------------------------------------
    ---------------------------------------------------------
    |             |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
    |-------------------------------------------------------|
    |      x      |   1.348    |    3.438     |    1.854    |
    |      y      |   1.448    |    3.860     |    1.965    |
    |      z      |   1.420    |    3.862     |    1.965    |
    |  Position   |   1.405    |    3.720     |    1.929    |
    |  Amplitude  |   0.539    |    0.650     |    0.806    |
    ---------------------------------------------------------
    """

    # NB, weight = '1, 1'
    # model = torch.load('trained_models/amplitudes_test_custom_loss_tanh_32_0.001_0.35_0.1_0_1500_(1).pt')
    """
    Mean Euclidean Distance (MED) is 2.853764533996582
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    63.330    |    89.990    |    99.540     |    99.915     |
    -----------------------------------------------------------------------
    No handles with labels found to put in legend.
    Mean Absolute Error (MAE) for amplitude is 0.545149028301239
    ---------------------------------------------------------------------------------
    |             |  MAE < 1.0 mA$mu$m  |  MAE < 2.0 mA$mu$m  |  MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------|
    |  amplitude  |       84.840        |       96.975        |       99.225        |
    ---------------------------------------------------------------------------------
    ---------------------------------------------------------------------------------------------------------------------------------
    |                   |  MED < 10 mm & MAE < 1.0 mA$mu$m  |  MED < 10 mm & MAE < 2.0 mA$mu$m  |  MED < 10 mm & MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------------------------------------------------------|
    |  pos & amplitude  |              84.505               |              96.590               |              98.810               |
    ---------------------------------------------------------------------------------------------------------------------------------
    ---------------------------------------------------------
    |             |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
    |-------------------------------------------------------|
    |      x      |   1.378    |    3.538     |    1.881    |
    |      y      |   1.498    |    4.214     |    2.053    |
    |      z      |   1.405    |    3.738     |    1.933    |
    |  Position   |   1.427    |    3.830     |    1.957    |
    |  Amplitude  |   0.545    |    0.658     |    0.811    |
    ---------------------------------------------------------
    """

    # NB, weigh = '0.3, 0.7'
    # model = torch.load('trained_models/amplitudes_custom_loss_tanh_32_0.001_0.35_0.1_0_1500_(7).pt')
    """
    Mean Euclidean Distance (MED) is 3.6360387802124023
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    44.965    |    80.500    |    98.605     |    99.740     |
    -----------------------------------------------------------------------
    No handles with labels found to put in legend.
    Mean Absolute Error (MAE) for amplitude is 0.5501509308815002
    ---------------------------------------------------------------------------------
    |             |  MAE < 1.0 mA$mu$m  |  MAE < 2.0 mA$mu$m  |  MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------|
    |  amplitude  |       84.665        |       96.905        |       99.145        |
    ---------------------------------------------------------------------------------
    ---------------------------------------------------------------------------------------------------------------------------------
    |                   |  MED < 10 mm & MAE < 1.0 mA$mu$m  |  MED < 10 mm & MAE < 2.0 mA$mu$m  |  MED < 10 mm & MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------------------------------------------------------|
    |  pos & amplitude  |              83.565               |              95.640               |              97.835               |
    ---------------------------------------------------------------------------------------------------------------------------------
    ---------------------------------------------------------
    |             |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
    |-------------------------------------------------------|
    |      x      |   1.714    |    5.306     |    2.304    |
    |      y      |   1.941    |    7.096     |    2.664    |
    |      z      |   1.791    |    6.140     |    2.478    |
    |  Position   |   1.815    |    6.181     |    2.486    |
    |  Amplitude  |   0.550    |    0.673     |    0.820    |
    ---------------------------------------------------------
    """
    # NB, weight = '1, 2'
    # model = torch.load('trained_models/amplitudes_test_custom_loss_tanh_32_0.001_0.35_0.1_0_1500_(2).pt')

    # model = torch.load('trained_models/amplitudes_new_custom_loss_tanh_32_0.001_0.35_0.1_0_2000_(1).pt')
    # model = torch.load('trained_models/amplitudes_new_custom_loss_tanh_32_0.001_0.35_0.1_0_2000_(0).pt')


    # NB, tanh all the way
    # model = torch.load('trained_models/amplitudes_new_standarization_tanh_32_0.001_0.35_0.1_0_3000_(1).pt')






    # Two dipoles
    # model = torch.load('trained_models/amplitudes_32_0.001_0.35_0.5_0_6000_(1).pt')
    # model = torch.load('trained_models/amplitudes_64_0.001_0.35_0.1_1e-05_3000_(1).pt')
    # model = torch.load('trained_models/amplitudes_32_0.001_0.35_0.1_0_10000_(0).pt')
    # model = torch.load('trained_models/amplitudes_32_0.001_0.35_0.1_0_6000_(3).pt')


    # model = torch.load('trained_models/amplitudes_custom_loss_32_0.001_0.35_0.1_0_8000_(0).pt')
    """
    Mean Euclidean Distance (MED) is 47.496925354003906
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    1.290     |    4.850     |    19.145     |    31.235     |
    -----------------------------------------------------------------------
    """

    # model = torch.load('trained_models/simple_custom_loss_constA_ReLU_32_0.001_0.35_0.1_0_1500_(0).pt')
    """
    relu in hidden, reul in first
    Mean Euclidean Distance (MED) is 44.97166061401367
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    6.700     |    19.240    |    40.185     |    46.790     |
    -----------------------------------------------------------------------
    """


    # model = torch.load('trained_models/simple_custom_loss_constA_32_0.001_0.35_0.1_0_1500_(0).pt')
    """
    tanh in hidden, relu in first
    Mean Euclidean Distance (MED) is 44.69486999511719
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    4.540     |    14.775    |    37.380     |    45.755     |
    -----------------------------------------------------------------------
    """
    # model = torch.load('trained_models/simple_custom_loss_tanh_32_0.001_0.35_0.1_0_1500_(1).pt')
    """
    Mean Euclidean Distance (MED) is 46.394039154052734
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    2.310     |    8.480     |    26.375     |    37.670     |
    -----------------------------------------------------------------------
    """

    # model = torch.load('trained_models/simple_custom_loss_relu_32_0.001_0.35_0.1_0_1500_(1).pt')
    """
    Mean Euclidean Distance (MED) is 47.358367919921875
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 15 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    1.050     |    4.180     |    18.710     |    31.830     |
    -----------------------------------------------------------------------
    """

    # model = torch.load('trained_models/simple_custom_loss_tanh_32_0.001_0.35_0.1_0_2000_(1).pt')


    # model = torch.load('trained_models/simplellrelu_custom_loss_relu_32_0.001_0.35_0.1_0_1500_(0).pt')

    # model = torch.load('trained_models/simple_custom_sigmoid_new_standarization_tanh_32_0.001_0.35_0.1_0_1500_(0).pt')






    # Area
    # model = torch.load('trained_models/area_32_0.001_0.35_0.1_0.0_5000_(0).pt')
    # model = torch.load('trained_models/area_custom_loss_ReLU_32_0.001_0.35_0.1_0_1500_(1).pt')


    #OMG:
    # model = torch.load('trained_models/area_custom_loss_32_0.001_0.35_0.1_0_6000_(0).pt')

    """
        Mean Euclidean Distance (MED) is 7.583307266235352
        -----------------------------------------------------------------------
        |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 12 mm  |
        |---------------------------------------------------------------------|
        |  pos  |    27.760    |    55.430    |    80.185     |    83.935     |
        -----------------------------------------------------------------------
        No handles with labels found to put in legend.
        Mean Absolute Error (MAE) for amplitude is 0.328752726316452
        ---------------------------------------------------------------------------------
        |             |  MAE < 1.0 mA$mu$m  |  MAE < 2.0 mA$mu$m  |  MAE < 3.0 mA$mu$m  |
        |-------------------------------------------------------------------------------|
        |  amplitude  |       92.750        |       98.555        |       99.665        |
        ---------------------------------------------------------------------------------
        No handles with labels found to put in legend.
        ---------------------------------------------------------------------------------------------------------------------------------
        |                   |  MED < 10 mm & MAE < 1.0 mA$mu$m  |  MED < 10 mm & MAE < 2.0 mA$mu$m  |  MED < 10 mm & MAE < 3.0 mA$mu$m  |
        |-------------------------------------------------------------------------------------------------------------------------------|
        |  pos & amplitude  |              74.795               |              79.375               |              80.040               |
        ---------------------------------------------------------------------------------------------------------------------------------
        Mean Absolute Error (MAE) for area is 0.772546112537384
        -------------------------------------------------------------
        |        |  MAE < 1.0 mm  |  MAE < 3.0 mm  |  MAE < 5.0 mm  |
        |-----------------------------------------------------------|
        |  area  |     74.055     |     98.120     |     99.740     |
        -------------------------------------------------------------
        No handles with labels found to put in legend.
        ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        |                            |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 1.0 mm  |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 3.0 mm  |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 5.0 mm  |
        |-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
        |  pos & amplitude & radius  |                      60.310                      |                      79.210                      |                      80.025                      |
        ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
        ---------------------------------------------------------
        |             |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
        |-------------------------------------------------------|
        |      x      |   3.755    |    42.788    |    6.541    |
        |      y      |   4.179    |    60.158    |    7.756    |
        |      z      |   3.547    |    38.675    |    6.219    |
        |  Position   |   3.827    |    47.207    |    6.871    |
        |  Amplitude  |   0.329    |    0.319     |    0.565    |
        ---------------------------------------------------------

    """

    # model = torch.load('trained_models/area_custom_loss_32_0.001_0.35_0.5_0_6000_(0).pt')

    # model = torch.load('trained_models/area_new_standarization_tanh_32_0.001_0.35_0.1_0_1500_(1).pt')

    """
    NBNBNB!!! tanh in first layer and different standarization:

        Mean Euclidean Distance (MED) is 8.009358406066895
    -----------------------------------------------------------------------
    |       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 12 mm  |
    |---------------------------------------------------------------------|
    |  pos  |    24.190    |    51.265    |    82.505     |    86.875     |
    -----------------------------------------------------------------------
    No handles with labels found to put in legend.
    Mean Absolute Error (MAE) for amplitude is 0.3338105380535126
    ---------------------------------------------------------------------------------
    |             |  MAE < 1.0 mA$mu$m  |  MAE < 2.0 mA$mu$m  |  MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------|
    |  amplitude  |       92.280        |       98.470        |       99.685        |
    ---------------------------------------------------------------------------------
    No handles with labels found to put in legend.
    ---------------------------------------------------------------------------------------------------------------------------------
    |                   |  MED < 10 mm & MAE < 1.0 mA$mu$m  |  MED < 10 mm & MAE < 2.0 mA$mu$m  |  MED < 10 mm & MAE < 3.0 mA$mu$m  |
    |-------------------------------------------------------------------------------------------------------------------------------|
    |  pos & amplitude  |              76.765               |              81.660               |              82.335               |
    ---------------------------------------------------------------------------------------------------------------------------------
    Mean Absolute Error (MAE) for area is 0.7416873574256897
    -------------------------------------------------------------
    |        |  MAE < 1.0 mm  |  MAE < 3.0 mm  |  MAE < 5.0 mm  |
    |-----------------------------------------------------------|
    |  area  |     75.215     |     98.175     |     99.735     |
    -------------------------------------------------------------
    No handles with labels found to put in legend.
    ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    |                            |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 1.0 mm  |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 3.0 mm  |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 5.0 mm  |
    |-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    |  pos & amplitude & radius  |                      62.165                      |                      81.595                      |                      82.290                      |
    ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
    ---------------------------------------------------------
    |             |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
    |-------------------------------------------------------|
    |      x      |   3.912    |    54.737    |    7.398    |
    |      y      |   4.313    |    74.436    |    8.628    |
    |      z      |   3.770    |    47.665    |    6.904    |
    |  Position   |   3.998    |    58.946    |    7.678    |
    |  Amplitude  |   0.334    |    0.331     |    0.575    |
    ---------------------------------------------------------
    """

    # model = torch.load('trained_models/area_new_custom_loss_tanh_32_0.001_0.35_0.1_0_1500_(0).pt')

    """
    Mean Euclidean Distance (MED) is 7.43090295791626
-----------------------------------------------------------------------
|       |  MED < 3 mm  |  MED < 5 mm  |  MED < 10 mm  |  MED < 12 mm  |
|---------------------------------------------------------------------|
|  pos  |    27.130    |    55.665    |    85.025     |    88.590     |
-----------------------------------------------------------------------
No handles with labels found to put in legend.
Mean Absolute Error (MAE) for amplitude is 0.32234683632850647
---------------------------------------------------------------------------------
|             |  MAE < 1.0 mA$mu$m  |  MAE < 2.0 mA$mu$m  |  MAE < 3.0 mA$mu$m  |
|-------------------------------------------------------------------------------|
|  amplitude  |       92.865        |       98.585        |       99.725        |
---------------------------------------------------------------------------------
No handles with labels found to put in legend.
---------------------------------------------------------------------------------------------------------------------------------
|                   |  MED < 10 mm & MAE < 1.0 mA$mu$m  |  MED < 10 mm & MAE < 2.0 mA$mu$m  |  MED < 10 mm & MAE < 3.0 mA$mu$m  |
|-------------------------------------------------------------------------------------------------------------------------------|
|  pos & amplitude  |              79.615               |              84.195               |              84.865               |
---------------------------------------------------------------------------------------------------------------------------------
Mean Absolute Error (MAE) for area is 0.729033887386322
-------------------------------------------------------------
|        |  MAE < 1.0 mm  |  MAE < 3.0 mm  |  MAE < 5.0 mm  |
|-----------------------------------------------------------|
|  area  |     75.955     |     98.310     |     99.745     |
-------------------------------------------------------------
No handles with labels found to put in legend.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
|                            |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 1.0 mm  |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 3.0 mm  |  MED < 10 mm & MAE < 3.0 mA$mu$m & MAE < 5.0 mm  |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  pos & amplitude & radius  |                      64.775                      |                      84.090                      |                      84.825                      |
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------
|             |  MAE (mm)  |  MSE (mm^2)  |  RMSE (mm)  |
|-------------------------------------------------------|
|      x      |   3.619    |    47.210    |    6.871    |
|      y      |   3.955    |    65.432    |    8.089    |
|      z      |   3.545    |    43.981    |    6.632    |
|  Position   |   3.707    |    52.208    |    7.225    |
|  Amplitude  |   0.322    |    0.308     |    0.555    |
---------------------------------------------------------
    """
    # Try out new standarization with relu first layer !!

    # model = torch.load('trained_models/area_custom_new_standarization_tanh_32_0.001_0.35_0.1_0_1500_(0).pt')




    print('Pretrained model loaded')
    validate_network(model, area.basic_parameters())

if __name__ == '__main__':
    main()
